name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    name: Flutter Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.8"
          channel: stable
          cache: true

      - name: Generate Firebase options stub for CI
        run: |
          cat > lib/firebase_options.dart << 'DART'
          // CI stub â€” real file is gitignored and contains secrets.
          // ignore_for_file: type=lint
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart'
              show defaultTargetPlatform, kIsWeb, TargetPlatform;
          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              switch (defaultTargetPlatform) {
                case TargetPlatform.android:
                  return android;
                case TargetPlatform.iOS:
                  return ios;
                default:
                  return android;
              }
            }
            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'ci-stub',
              appId: '1:000000000000:android:0000000000000000',
              messagingSenderId: '000000000000',
              projectId: 'ci-stub',
            );
            static const FirebaseOptions ios = FirebaseOptions(
              apiKey: 'ci-stub',
              appId: '1:000000000000:ios:0000000000000000',
              messagingSenderId: '000000000000',
              projectId: 'ci-stub',
              iosBundleId: 'me.jakev.myflashcards',
            );
          }
          DART

      - name: Install dependencies
        run: flutter pub get

      - name: Verify formatting
        run: dart format --output=none --set-exit-if-changed lib/ test/

      - name: Analyze
        run: flutter analyze --no-fatal-infos

      - name: Run tests
        run: flutter test --coverage
        env:
          # GEMINI_API_KEY is only needed for integration/manual tests.
          # Unit tests mock the service so this can be empty and CI still passes.
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false
